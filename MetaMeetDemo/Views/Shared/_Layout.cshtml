<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - MetaMeet</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: #f4f7f6;
        }

        .navbar-custom {
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            padding: 10px 20px;
        }

        .nav-link {
            font-weight: 500;
            color: #555 !important;
            transition: 0.2s;
        }

            .nav-link:hover, .nav-link.active {
                color: #667eea !important;
            }

        .notification-bell {
            position: relative;
            cursor: pointer;
            font-size: 20px;
            margin-right: 15px;
            user-select: none;
        }

        .badge-notification {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: white;
            font-size: 10px;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            display: none;
        }

        .avatar-nav {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            display: block;
        }

        .avatar-initials-nav {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 13px;
            text-transform: uppercase;
            user-select: none;
        }

        .dropdown-menu {
            z-index: 1050;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-custom fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" asp-area="" asp-controller="Home" asp-action="Index">
                <img src="~/img/1000019468.svg" alt="MetaMeet Logo" style="height: 32px; width: 32px; margin-right: 10px;" />

                <span style="font-weight: 700; font-size: 1.4rem; color: #1f2937;">
                    MetaMeet
                </span>
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a href="/Dashboard" class="nav-link">Pulpit</a></li>
                    <li class="nav-item"><a href="/Calendar" class="nav-link">Kalendarz</a></li>
                    <li class="nav-item"><a href="/Meetings" class="nav-link">Moje Spotkania</a></li>
                    <li class="nav-item"><a href="/Schedule" class="nav-link">Umów Spotkanie</a></li>
                    <li class="nav-item"><a href="/Team" class="nav-link">Zespół</a></li>
                    <li class="nav-item"><a href="/Profile" class="nav-link">Profil</a></li>
                </ul>

                <div class="d-flex align-items-center">
                    <div class="notification-bell" onclick="toggleNotifications()">
                        🔔
                        <span class="badge-notification" id="notifBadge">0</span>
                    </div>

                    <div class="dropdown">
                        <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle" id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false">

                            <div id="navAvatarContainer" class="me-2">
                                <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                            </div>

                            <span class="fw-bold text-dark" id="navUserName">...</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
                            <li><a class="dropdown-item" href="/Settings">Ustawienia</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="/MicrosoftIdentity/Account/SignOut">Wyloguj</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top: 80px; padding-bottom: 40px;">
        @RenderBody()
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            try {
                const resp = await fetch('/api/current-user-basic');
                if(resp.ok) {
                    const user = await resp.json();

                    document.getElementById('navUserName').textContent = user.displayName;

                    await loadNavbarAvatar(user.displayName);

                    checkNotifications(user.id);
                    setInterval(() => checkNotifications(user.id), 30000);
                }
            } catch(e) { console.error("Błąd inicjalizacji navbaru:", e); }
        });

        async function loadNavbarAvatar(displayName) {
            const container = document.getElementById('navAvatarContainer');

            try {
                const resp = await fetch('/api/user-photo');

                if(resp.ok) {
                    const blob = await resp.blob();
                    const url = URL.createObjectURL(blob);
                    container.innerHTML = `<img src="${url}" class="avatar-nav" alt="Avatar">`;
                } else {
                    throw new Error("Brak zdjęcia");
                }
            } catch(e) {
                container.innerHTML = getInitialsHtml(displayName);
            }
        }

        function getInitialsHtml(name) {
            if (!name) return '';
            const parts = name.trim().split(' ');
            let initials = parts[0][0];
            if (parts.length > 1) initials += parts[parts.length - 1][0];

            let hash = 0;
            for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
            const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            const color = "#" + "00000".substring(0, 6 - c.length) + c;

            return `<div class="avatar-initials-nav" style="background-color: ${color};">${initials.toUpperCase()}</div>`;
        }

        async function checkNotifications(userId) {
            try {
                const resp = await fetch(`/api/notifications/${userId}`);
                if(resp.ok) {
                    const notifs = await resp.json();
                    const count = notifs.filter(n => !n.isRead).length;
                    const badge = document.getElementById('notifBadge');

                    if(count > 0) {
                        badge.style.display = 'flex';
                        badge.textContent = count > 9 ? '9+' : count;
                    } else {
                        badge.style.display = 'none';
                    }
                }
            } catch(e) {}
        }

        function toggleNotifications() {
            window.location.href = "/Team";
        }
    </script>
</body>
</html>