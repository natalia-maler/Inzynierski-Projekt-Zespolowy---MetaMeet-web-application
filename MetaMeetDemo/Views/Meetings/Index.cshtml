@{
    ViewData["Title"] = "Moje Spotkania";
}

<style>
    :root {
        --text-main: #1f2937;
        --text-muted: #6b7280;
        --primary-purple: #6264A7;
        --primary-hover: #4e5085;
        --light-purple: #EEF0F8;
        --border-color: #e5e7eb;
        --status-success-bg: #dcfce7;
        --status-success-text: #166534;
        --status-error-bg: #fee2e2;
        --status-error-text: #991b1b;
        --status-warn-bg: #fef3c7;
        --status-warn-text: #92400e;
        --card-shadow: 0 4px 20px rgba(0,0,0,0.05);
        --card-radius: 6px;
    }

    body {
        font-family: 'Segoe UI', sans-serif;
    }

    .container-meetings {
        max-width: 1400px;
        margin: 40px auto;
        width: 95%;
    }

    h1 {
        color: var(--text-main);
        margin-bottom: 30px;
        font-size: 28px;
        font-weight: 700;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
    }

    .header-logo {
        width: 36px;
        height: 36px;
        object-fit: contain;
    }

    .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        border-bottom: 1px solid var(--border-color);
        justify-content: center;
    }

    .tab {
        padding: 12px 24px;
        cursor: pointer;
        border: none;
        background: none;
        font-size: 15px;
        font-weight: 600;
        color: var(--text-muted);
        border-bottom: 3px solid transparent;
        transition: all 0.2s;
    }

        .tab:hover {
            color: var(--primary-purple);
        }

        .tab.active {
            color: var(--primary-purple);
            border-bottom-color: var(--primary-purple);
        }

    .tab-content {
        display: none;
    }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(5px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .columns {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
    }

    .column {
        background: #f9fafb;
        padding: 20px;
        border-radius: var(--card-radius);
        border: 1px solid var(--border-color);
        max-height: 750px;
        overflow-y: auto;
    }

    .column-header {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-main);
        padding-bottom: 15px;
        margin-bottom: 15px;
        border-bottom: 2px solid var(--light-purple);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .meeting-card {
        background: white;
        border-radius: var(--card-radius);
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        border: 1px solid var(--border-color);
        transition: all 0.2s;
    }

        .meeting-card:hover {
            box-shadow: 0 8px 16px rgba(0,0,0,0.06);
            transform: translateY(-2px);
            border-color: var(--primary-purple);
        }

    .meeting-header {
        display: flex;
        align-items: flex-start;
        gap: 15px;
        margin-bottom: 12px;
    }

    .meeting-icon {
        width: 36px;
        height: 36px;
        object-fit: contain;
        flex-shrink: 0;
    }

    .meeting-subject {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-main);
        line-height: 1.3;
        margin-top: 5px;
    }

    .meeting-time {
        background: var(--light-purple);
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 13px;
        color: var(--primary-purple);
        font-weight: 600;
        margin: 8px 0;
        display: inline-block;
    }

    .organizer {
        font-size: 13px;
        color: var(--text-muted);
        margin-bottom: 5px;
    }

    .meeting-actions {
        display: flex;
        gap: 8px;
        margin-top: 15px;
        flex-wrap: wrap;
    }

    .btn-action {
        padding: 6px 14px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .btn-join {
        background: linear-gradient(135deg, #6264A7 0%, #8B8DC8 100%);
        color: white;
    }

        .btn-join:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(98, 100, 167, 0.3);
            color: white;
        }

    .btn-cancel {
        background: var(--status-error-bg);
        color: var(--status-error-text);
    }

        .btn-cancel:hover {
            background: #fecaca;
        }

    .btn-decline {
        background: #f3f4f6;
        color: var(--text-main);
        border: 1px solid #e5e7eb;
    }

        .btn-decline:hover {
            background: #e5e7eb;
        }

    .btn-restore {
        background: var(--status-success-bg);
        color: var(--status-success-text);
    }

        .btn-restore:hover {
            background: #bbf7d0;
        }

    .cancelled-badge {
        display: inline-block;
        padding: 4px 8px;
        background: var(--status-error-bg);
        color: var(--status-error-text);
        font-weight: 700;
        border-radius: 4px;
        font-size: 11px;
        text-transform: uppercase;
        margin-top: 5px;
    }

    .week-nav {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin-bottom: 30px;
        background: white;
        padding: 15px;
        border-radius: var(--card-radius);
        box-shadow: var(--card-shadow);
        width: fit-content;
        margin-left: auto;
        margin-right: auto;
    }

    .date-icon {
        width: 24px;
        height: 24px;
        vertical-align: middle;
        margin-right: 8px;
        margin-bottom: 4px;
    }

    .nav-arrow {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: var(--text-muted);
        transition: color 0.2s;
    }

        .nav-arrow:hover {
            color: var(--primary-purple);
        }

    .refresh-btn {
        background: white;
        color: var(--primary-purple);
        border: 1px solid var(--primary-purple);
        padding: 8px 20px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: block;
        margin: 0 auto 30px;
        transition: all 0.2s;
    }

        .refresh-btn:hover {
            background: var(--light-purple);
        }

    .loading, .empty-state {
        text-align: center;
        padding: 40px;
        color: var(--text-muted);
    }

    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--primary-purple);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }

    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .attendees-compact {
        margin-top: 10px;
        font-size: 12px;
        color: var(--text-muted);
    }

    .attendee-badge {
        background: #f3f4f6;
        color: var(--text-main);
        padding: 2px 8px;
        border-radius: 10px;
        margin-right: 4px;
        display: inline-block;
        margin-bottom: 4px;
    }
</style>

<div class='container-meetings'>

    <h1>
        <img src="/img/1000019468.svg" class="header-logo" alt="Logo" />
        Moje Spotkania
    </h1>

    <button class='refresh-btn' onclick='loadMeetings()'>Odśwież dane</button>

    <div class='tabs'>
        <button class='tab active' data-tab='active'>Aktywne</button>
        <button class='tab' data-tab='rejected'>Odrzucone</button>
        <button class='tab' data-tab='cancelled'>Anulowane</button>
    </div>

    <div class="week-nav">
        <button onclick="changeWeek(-1)" class="nav-arrow">⬅</button>
        <div id="week-range" style="font-size:16px; font-weight:700; color:var(--text-main); display:flex; align-items:center;">
            ...
        </div>
        <button onclick="changeWeek(1)" class="nav-arrow">➡</button>
    </div>

    <div id='active-tab' class='tab-content active'>
        <div class="columns">
            <div class="column">
                <div class="column-header">Organizowane przeze mnie</div>
                <div id='organized-meetings'>
                    <div class='loading'><div class='spinner'></div><p>Ładowanie...</p></div>
                </div>
            </div>
            <div class="column">
                <div class="column-header">Zaproszenia</div>
                <div id='invited-meetings'>
                    <div class='loading'><div class='spinner'></div><p>Ładowanie...</p></div>
                </div>
            </div>
        </div>
    </div>

    <div id='rejected-tab' class='tab-content'>
        <div class='column' style="max-width: 800px; margin: 0 auto;">
            <div id='rejected-meetings'>
                <div class='loading'><div class='spinner'></div><p>Ładowanie...</p></div>
            </div>
        </div>
    </div>

    <div id='cancelled-tab' class='tab-content'>
        <div class='column' style="max-width: 800px; margin: 0 auto;">
            <div id='cancelled-meetings'>
                <div class='loading'><div class='spinner'></div><p>Ładowanie...</p></div>
            </div>
        </div>
    </div>
</div>

<script>
    let meetingsData = null;

    document.querySelectorAll(".tab").forEach(tab => {
        tab.addEventListener("click", () => {
            document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
            document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));

            tab.classList.add("active");

            const tabName = tab.getAttribute("data-tab");
            const target = document.getElementById(tabName + "-tab");
            if(target) target.classList.add("active");
        });
    });

    function formatDateTime(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleString("pl-PL", { day: "2-digit", month: "2-digit", hour: "2-digit", minute: "2-digit" });
    }

    function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
    }

    function renderAttendees(attendees, organizerEmail) {
        if (!attendees || attendees.length === 0) return '<div class="attendees-compact">Brak uczestników</div>';
        const filtered = attendees.filter(a => a.email && organizerEmail && a.email.toLowerCase() !== organizerEmail.toLowerCase());
        if (filtered.length === 0) return '<div class="attendees-compact">Tylko organizator</div>';

        let html = '<div class="attendees-compact">Uczestnicy: ';
        html += filtered.slice(0, 3).map(a => `<span class="attendee-badge">${escapeHtml(a.name)}</span>`).join('');
        if (filtered.length > 3) html += ` <span class="text-muted">+${filtered.length - 3} innych</span>`;
        html += '</div>';
        return html;
    }

    function createMeetingCard(meeting, showCancelBtn = false, showDeclineBtn = false, showRestoreBtn = false) {
        const startTime = formatDateTime(meeting.start);
        const endTime = formatDateTime(meeting.end);
        const attendeesHtml = renderAttendees(meeting.attendees, meeting.organizerEmail);

        const isMetaMeet = (meeting.subject || "").includes("[MetaMeet]");
        const iconUrl = isMetaMeet ? '/img/1000019468.svg' : '/img/outlook.png';

        const displaySubject = isMetaMeet
            ? (meeting.subject || "").replace("[MetaMeet]", "").trim()
            : (meeting.subject || "Brak tematu");

        const joinBtn = meeting.joinUrl && !meeting.isCancelled
            ? `<a href="${escapeHtml(meeting.joinUrl)}" target="_blank" class="btn-action btn-join">Dołącz</a>` : "";

        const cancelBtn = showCancelBtn ? `<button class="btn-action btn-cancel" onclick="cancelMeeting('${escapeHtml(meeting.id)}')">Anuluj</button>` : "";
        const declineBtn = showDeclineBtn ? `<button class="btn-action btn-decline" onclick="declineMeeting('${escapeHtml(meeting.iCalUId)}')">Odrzuć</button>` : "";
        const restoreBtn = showRestoreBtn ? `<button class="btn-action btn-restore" onclick="restoreMeeting('${escapeHtml(meeting.iCalUId)}')">Przywróć</button>` : "";

        const cancelledBadge = (meeting.categories && meeting.categories.includes("Anulowane")) || meeting.isCancelled
            ? `<div class="cancelled-badge">ANULOWANE</div>` : "";

        return `
            <div class="meeting-card">
                <div class="meeting-header">
                    <img src="${iconUrl}" class="meeting-icon" alt="Icon" />

                    <div class="meeting-subject">
                        ${escapeHtml(displaySubject)}
                    </div>
                </div>

                <div class="organizer">
                    Organizator: <strong>${escapeHtml(meeting.organizer)}</strong>
                </div>

                <div class="meeting-time">
                    ${startTime} - ${endTime}
                </div>

                ${attendeesHtml}
                ${cancelledBadge}

                <div class="meeting-actions">
                    ${joinBtn}
                    ${cancelBtn}
                    ${declineBtn}
                    ${restoreBtn}
                </div>
            </div>
        `;
    }

    function renderMeetings() {
        if (!meetingsData) return;

        const sections = [
            { id: "organized-meetings", data: meetingsData.organized, empty: "Brak organizowanych spotkań", cancel: true },
            { id: "invited-meetings", data: meetingsData.invited, empty: "Brak zaproszeń", decline: true },
            { id: "rejected-meetings", data: meetingsData.rejected, empty: "Brak odrzuconych spotkań", restore: true },
            { id: "cancelled-meetings", data: meetingsData.cancelled, empty: "Brak anulowanych spotkań" }
        ];

        sections.forEach(section => {
            const container = document.getElementById(section.id);
            if (container) {
                if (!section.data || section.data.length === 0) {
                    container.innerHTML = `<div class="empty-state"><p>${section.empty}</p></div>`;
                } else {
                    container.innerHTML = section.data
                        .map(m => createMeetingCard(m, section.cancel, section.decline, section.restore))
                        .join("");
                }
            }
        });
    }

    function toLocalIso(date) {
        return date.getFullYear() + "-" + String(date.getMonth() + 1).padStart(2, "0") + "-" + String(date.getDate()).padStart(2, "0") + "T00:00:00";
    }

     async function loadMeetings() {
          try {
              const monday = new Date(currentWeekStart);
              const sunday = new Date(currentWeekStart);
              sunday.setDate(sunday.getDate() + 6);

              const response = await fetch(`/api/meetings/list?start=${encodeURIComponent(toLocalIso(monday))}&end=${encodeURIComponent(toLocalIso(sunday))}`);

              if (!response.ok) throw new Error("Błąd");
              meetingsData = await response.json();
              renderMeetings();
          } catch (error) {
              console.error(error);
              ['organized-meetings', 'invited-meetings', 'rejected-meetings', 'cancelled-meetings'].forEach(id => {
                  const el = document.getElementById(id);
                  if(el) el.innerHTML = `<div class="empty-state">Błąd pobierania danych.</div>`;
              });
          }
      }

    async function cancelMeeting(id) { if(confirm("Anulować?")) await apiCall(`/api/meetings/cancel?eventId=${id}`); }
    async function declineMeeting(id) { if(confirm("Odrzucić?")) await apiCall(`/api/meetings/decline?icalUid=${id}`); }
    async function restoreMeeting(id) { if(confirm("Przywrócić?")) await apiCall(`/api/meetings/accept?icalUid=${id}`); }
  async function apiCall(url) {
        try {
            const response = await fetch(url, { method: "POST" });
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || `Błąd serwera: ${response.status}`);
            }

            if (!data.success) {
                throw new Error(data.error || "Operacja nie powiodła się.");
            }

            await loadMeetings();

        } catch (error) {
            console.error("Błąd akcji:", error);
            alert("Wystąpił błąd: " + error.message);
        }
    }

    async function cancelMeeting(id) {
        if (confirm("Czy na pewno chcesz anulować to spotkanie?")) {
            await apiCall(`/api/meetings/cancel?eventId=${encodeURIComponent(id)}`);
        }
    }

    async function declineMeeting(id) {
        if (confirm("Czy na pewno chcesz odrzucić to zaproszenie?")) {
            await apiCall(`/api/meetings/decline?icalUid=${encodeURIComponent(id)}`);
        }
    }

    async function restoreMeeting(id) {
        if (confirm("Czy chcesz przywrócić to spotkanie?")) {
            await apiCall(`/api/meetings/accept?icalUid=${encodeURIComponent(id)}`);
        }
    }

    let currentWeekStart = getMonday(new Date());
    function getMonday(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - (day === 0 ? 6 : day - 1);
        return new Date(d.setDate(diff));
    }
    function formatDate(date) { return date.toLocaleDateString("pl-PL", { day: "2-digit", month: "2-digit" }); }

    function updateWeekHeader() {
        const monday = new Date(currentWeekStart);
        const sunday = new Date(currentWeekStart);
        sunday.setDate(sunday.getDate() + 6);

        document.getElementById("week-range").innerHTML = `${formatDate(monday)} – ${formatDate(sunday)}`;
    }

    function changeWeek(d) { currentWeekStart.setDate(currentWeekStart.getDate() + d * 7); updateWeekHeader(); loadMeetings(); }

    updateWeekHeader();
    loadMeetings();
</script>